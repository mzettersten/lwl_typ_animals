---
title: "CATegories - cluster-based permutation analysis"
author: "Anonymized"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
---

## Load packages

```{r setup, message=FALSE}

library(tidyverse)
library(here)
library(readxl)
library(eyetrackingR)
source("resampling_helper.R")

set.seed(24)

knitr::opts_chunk$set(cache = FALSE, warn = FALSE,warning=FALSE, message = FALSE)
```

## Load data

```{r}
#set paths
data_file_path <- here::here("..","..","data","processed_data","CATegories_exp2_processed_data_with_exclusion_info.csv")
resampled_data_write_path <- here::here("..","..","data","processed_data","CATegories_exp2_processed_data_resampled.csv")

#load data
d <- read_csv(data_file_path) 
```

In this script, we focus on the cluster-based permutation analysis.

## 1.3

### Resampling

In order to plot participants' average proportion looking to the target across the trial, we smooth/ resample time. This is necessary when plotting the timecourses given the variable sampling rate in the data (otherwise the mean observations "jump around" due to varying contributing data composition at different time points).

```{r message=FALSE, warning=FALSE, results=FALSE}
target_ms_per_frame <- 1000/15
#resample times
d_resampled <- d %>%
  #rename and transform variables for resampling function
  mutate(
    aoi = case_when(
      accuracy_transformed == 1 ~ "target",
      accuracy_transformed == 0 ~ "distractor",
      is.na(accuracy_transformed) ~ "other"
    )
  ) %>%
  mutate(t_norm=time_normalized_corrected,
         trial_id = trial_number,
         administration_id = paste(sub_num,session,trial_order,sep="_")) %>%
  resample_times(sample_duration=target_ms_per_frame) #time resampling is set to 15 Hz
```


```{r}
#clean up resampled data
d_resampled_clean <- d_resampled %>%
  mutate(
    accuracy_transformed = case_when(
      aoi == "target" ~ 1,
      aoi == "distractor" ~ 0,
      aoi == "other" ~ NA
    )
  ) %>%
  separate(administration_id,into=c("exp_name","sub_number","session","trial_order"),sep="_",remove=F) %>%
  unite(sub_num,exp_name,sub_number,sep="_") %>%
  rename(trial_number=trial_id) %>%
  rename(time_normalized_corrected=t_norm) %>%
  mutate(session=as.numeric(session)) %>%
  mutate(time_normalized_corrected =round(time_normalized_corrected,0)) %>%
  select(-administration_id,-aoi) %>%
  select(sub_num,session,trial_order,trial_number,time_normalized_corrected,accuracy_transformed)
  
#check number of rows to make sure resampling rate is correct
nrow(d_resampled_clean)

#extract key information from full dataset
d_info <- d %>%
  select(-time_normalized_corrected,-accuracy_transformed) %>%
  distinct(sub_num, exclude_participant, trial_exclusion,trial_exclusion_reason,useable_window, age,age_mo, child_gender, condition, session,trial_order,trial_number,target_image,target_typicality_z)

#join with resampled data
d_resampled_clean <- d_resampled_clean %>%
  left_join(d_info)
  
write_csv(d_resampled_clean,resampled_data_write_path)
```

### Timecourse analysis - cluster-based permutation analysis

Next, we prepare the data for use with the eyetrackingR package

```{r}
d_eyetrackingr <- d_resampled_clean %>%
  filter(exclude_participant==0) %>%
  filter(useable_window==1) %>% # I think it would be safe to remove this
  filter(trial_exclusion==0) %>%
  unite("unique_trial",trial_order,trial_number,sep="_",remove=FALSE) %>%
  mutate(
    target = case_when(
      is.na(accuracy_transformed) ~ NA,
      accuracy_transformed == 1 ~ TRUE,
      accuracy_transformed == 0 ~ FALSE,
    ),
    distractor = case_when(
      is.na(accuracy_transformed) ~ NA,
      accuracy_transformed == 0 ~ TRUE,
      accuracy_transformed == 1 ~ FALSE,
    ),
    trackloss = case_when(
      is.na(accuracy_transformed) ~ TRUE,
      TRUE ~ FALSE
    )
  ) %>%
  make_eyetrackingr_data(
    participant_column = "sub_num",
    trial_column = "unique_trial",
    time_column = "time_normalized_corrected",
    trackloss_column = "trackloss",
    aoi_columns = c("target","distractor"),
    treat_non_aoi_looks_as_missing = TRUE
  )

#note that we analyze the entire timecourse here!
response_window <- subset_by_window(
  d_eyetrackingr,
  window_start_time = -2000,
  window_end_time = 4000,
  rezero=FALSE
)
summary_data_loss <- describe_data(response_window, 'target', 'sub_num')

response_time <- make_time_sequence_data(response_window,
                                  time_bin_size = 100, 
                                  predictor_columns = c("condition"),
                                  aois = "target",
                                  summarize_by = "sub_num" )

# visualize timecourse
plot(response_time, predictor_column = "condition") + 
  theme_light() +
  coord_cartesian(ylim = c(0,1))

#divergence analysis
# tb_analysis <- analyze_time_bins(data = response_time, predictor_column = "condition", test= 'boot_splines', within_subj = TRUE, bs_samples = 1000, alpha = .05/num_time_bins)
# plot(tb_analysis) + theme_light()
# summary(tb_analysis)

#bootstrapped cluster-based permutation analysis
n_samples <- 1000
threshold_t <- 2
df_timeclust <- make_time_cluster_data(response_time, 
                                      test= "t.test", paired=TRUE,
                                      predictor_column = "condition", 
                                      threshold = threshold_t) 
plot(df_timeclust) +  ylab("T-Statistic") + theme_light()
summary(df_timeclust)
```

Next, we run the clustering analysis. This next chunk may take a few minutes to run.

```{r}
#this next command may take a few minutes to execute
clust_analysis <- analyze_time_clusters(df_timeclust, within_subj=TRUE, paired=TRUE,
                                        samples=n_samples)
plot(clust_analysis) + theme_light()
summary(clust_analysis)
```

<!-- ## Test Type:    t.test  -->
<!-- ## Predictor:    condition  -->
<!-- ## Formula:  Prop ~ condition  -->
<!-- ## Null Distribution   ======  -->
<!-- ##  Mean:        -0.3103  -->
<!-- ##  2.5%:        -18.1421  -->
<!-- ## 97.5%:        16.9134  -->
<!-- ## Summary of Clusters ====== -->
<!-- ##   Cluster Direction SumStatistic StartTime EndTime Probability -->
<!-- ## 1       1  Negative    -4.665038         0     200       0.405 -->

In the cluster-based permutation analyses, we found one cluster of adjacent time bins ranging from 0-200ms with |t|>2 (in the direction of higher accuracy for typical exemplars compared to atypical exemplars). However, this cluster did not reach significance in the permutation test, p=.41.

### Exploratory Analysis: cluster-based permutation analysis with reduced window (300-2800 ms)

Next, we conducted an exploratory analysis testing whether we would get similar results for the cluster-based permutation analysis if we reduced the critical window size to the main window considered in the other preregistered analyses (300-2800ms).

```{r}
response_window <- subset_by_window(
  d_eyetrackingr,
  window_start_time = 300,
  window_end_time = 2800,
  rezero=FALSE
)
summary_data_loss <- describe_data(response_window, 'target', 'sub_num')

response_time <- make_time_sequence_data(response_window,
                                  time_bin_size = 100, 
                                  predictor_columns = c("condition"),
                                  aois = "target",
                                  summarize_by = "sub_num" )

# visualize timecourse
plot(response_time, predictor_column = "condition") + 
  theme_light() +
  coord_cartesian(ylim = c(0,1))

#divergence analysis
# tb_analysis <- analyze_time_bins(data = response_time, predictor_column = "condition", test= 'boot_splines', within_subj = TRUE, bs_samples = 1000, alpha = .05/num_time_bins)
# plot(tb_analysis) + theme_light()
# summary(tb_analysis)

#bootstrapped cluster-based permutation analysis
n_samples <- 1000
threshold_t <- 2
df_timeclust <- make_time_cluster_data(response_time, 
                                      test= "t.test", paired=TRUE,
                                      predictor_column = "condition", 
                                      threshold = threshold_t) 
plot(df_timeclust) +  ylab("T-Statistic") + theme_light()
summary(df_timeclust)
clust_analysis <- analyze_time_clusters(df_timeclust, within_subj=TRUE, paired=TRUE,
                                        samples=n_samples)
plot(clust_analysis) + theme_light()
summary(clust_analysis)
```

No candidate clusters emerged for this smaller critical window.
